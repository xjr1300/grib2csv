# GRIB2通報式による1kmメッシュ解析雨量・降水短時間予報データ・フォーマット

平成18年11月（2006年11月）気象庁予報部

- 日時は世界標準時で記録
- 提供データの経度方向の格子間隔は40秒
- 提供データの緯度方向の格子間隔は30秒
- 経度118〜150度、緯度20度〜48度の領域を記録
  - 経度118度は台湾よりも少し西、経度150度は択捉島の北東にある得撫島付近
  - 緯度20度は台湾とフィリピンの中間、緯度48度は千島列島の松輪島付近
- 経度方向は2,560格子、経度方向は3,360格子
- 1ファイルは8,601,600格子
- ファイルはバイナリでビッグ・エンディアンで記録
- 各データの内容は、「国際気象通報式・別冊」を参照
  - 最新は第38号（令和5年2月1日）
- 試験データがあるため、第1節20オクテットの作成ステータスを要確認
- 第7節のランレングス・オクテット列は、ランレングスで圧縮

| セクション | オクテット      | 内容                             | 表          | 値     | 備考                                                  |
| ---------- | --------------- | -------------------------------- | ----------- | ------ | ----------------------------------------------------- |
| 第0節      | 1 - 4           | GRIB                             | ー          | "GRIB" | ー                                                    |
| 第0節      | 7               | 資料分野                         | 符号表0.0   | 0      | 気象分野                                              |
| 第0節      | 8               | GRIB版番号                       | ー          | 2      | 気象分野                                              |
| 第1節      | 1 - 4           | 節の長さ                         | ー          | 21     | ー                                                    |
| 第1節      | 5               | 節番号                           | ー          | 1      | ー                                                    |
| 第1節      | 13 - 14         | 資料の参照時刻（年）             | ー          | ー     | ー                                                    |
| 第1節      | 15              | 資料の参照時刻（月）             | ー          | ー     | ー                                                    |
| 第1節      | 16              | 資料の参照時刻（日）             | ー          | ー     | ー                                                    |
| 第1節      | 17              | 資料の参照時刻（時）             | ー          | ー     | ー                                                    |
| 第1節      | 18              | 資料の参照時刻（分）             | ー          | ー     | ー                                                    |
| 第1節      | 19              | 資料の参照時刻（秒）             | ー          | ー     | ー                                                    |
| 第1節      | 20              | 作成ステータス                   | 符号表1.3   | ー     | 0:現業プロダクト、1:現業的試験プロダクト              |
| 第3節      | 1 - 4           | 節の長さ                         | ー          | 72     | ー                                                    |
| 第3節      | 5               | 節番号                           | ー          | 3      | ー                                                    |
| 第3節      | 7 - 10          | 資料点数                         | ー          | ー     | 20-48N, 118-150Eの範囲では2,560x3,360=8,601,600       |
| 第3節      | 15              | 地球の形状                       | 符号表3.2   | 4      | GRS80回転楕円体                                       |
| 第3節      | 31 - 34         | 緯線に沿った格子点数             | ー          | ー     | 20-48Nでは2,560                                       |
| 第3節      | 35 - 38         | 経線沿った格子点数               | ー          | ー     | 118-150Eでは3,360                                     |
| 第3節      | 47 - 50         | 最初（最も左上）の格子点の緯度   | 10^-6度単位 | ー     | 20-48Nでは、48N-(2/3)*(1/80)/2=47995833               |
| 第3節      | 51 - 54         | 最初（最も左上）の格子点の経度   | 10^-6度単位 | ー     | 118-150Eでは、118E+(1/80)/2=118006250                 |
| 第3節      | 56 - 59         | 最後（最も右下）の格子点の緯度   | 10^-6度単位 | ー     | 20-48Nでは、20N+(2/3)*(1/80)/2=20004167               |
| 第3節      | 60 - 63         | 最後（最も右下）の格子点の経度   | 10^-6度単位 | ー     | 118-150Eでは、150E-(1/80)/2=149993750                 |
| 第3節      | 64 - 67         | i方向（経度方向）の増分          | 10^-6度単位 | 12500  | 1/80                                                  |
| 第3節      | 68 - 71         | i方向（経度方向）の増分          | 10^-6度単位 | 8333   | (2/3)*(1/80)                                          |
| 第4節      | 1 - 4           | 節の長さ                         | ー          | ー     | ー                                                    |
| 第4節      | 5               | 節番号                           | ー          | 4      | ー                                                    |
| 第5節      | 1 - 4           | 節の長さ                         | ー          | ー     | 第5節18オクテット以降に記録されるレベル値の個数は可変 |
| 第5節      | 5               | 節番号                           | ー          | 5      | ー                                                    |
| 第5節      | 6 - 9           | 全資料点の数                     | ー          | ー     | 8601600                                               |
| 第5節      | 10 - 11         | 資料表現テンプレート番号         | ー          | 200    | ー                                                    |
| 第5節      | 12              | １データのビット数               | ー          | 8      | ー                                                    |
| 第5節      | 13 - 14         | 今回の圧縮に用いたレベルの最大値 | ー          | V      | Vは可変（<=M）                                        |
| 第5節      | 15 - 16         | データが取りうるレベルの最大値   | ー          | M      | 現解析雨量の場合は98                                  |
| 第5節      | 17              | データ代表値の尺度因子           | ー          | 1      | 現解析雨量の場合                                      |
| 第5節      | 16+2m - 16+2m+1 | レベルmの値                      | ー          | ー     | m=1〜M、レベル0（m=0）は欠測値、単位はmm/h            |
| 第6節      | 1 - 4           | 節の長さ                         | ー          | 6      | ー                                                    |
| 第6節      | 5               | 節番号                           | ー          | 6      | ー                                                    |
| 第6節      | 6               | ビットマップ指示符               | ー          | 255    | ビットマップを適応せず                                |
| 第7節      | 1 - 4           | 節の長さ                         | ー          | ー     | ー                                                    |
| 第7節      | 5               | 節番号                           | ー          | 7      | ー                                                    |
| 第7節      | 6 - n           | ランレングス・オクテット列       | ー          | ー     | 資料テンプレート7.200で記述された形式                 |
| 第8節      | 1 - 4           | 7777                             | ー          | "7777" | 国際アルファベットNo.5(CRIT IA5)                      |

- 第７節のランレングス・オクテット列は、レベル値の列を`GRIB2 資料テンプレート 7.200`で圧縮した結果を記録している。
- 格子点値が取りうるレベル値
  - レベル値は2次元矩形領域の格子点上に存在し、0以上MAXV以下の整数を取る。
  - ここでMAXVは、GRIB資料表現テンプレート5.200（気象庁定義資料表現テンプレート）第5節13-14オクテットで示される「今回の圧縮に用いたレベルの最大値」である。
    - 第5節15-16オクテットの「レベルの最大値」ではないことに注意すること。
- 2次元データの1次元化
  - 主走査方向を2次元矩形領域の左から右（通常西から東）、副走査方向を上から下（通常北から南）として、2次元データを1次元化する。
    - データは最も左上の格子点の値から始まり、東方向に向かって格子点のレベル値を記録する。
    - その緯度の最東端に達したら、下の最西端の格子点に移動して、上記同様に格子点のレベル値を記録する。
  - 最初のデータは最も左上の格子点の値であり、最後のデータは最も右下の格子点の値である。
- ランレングス符号化後の1格子点値当りのビット数（NBIT）
  - NBITは、ランレングス符号化されたデータ列の中で、レベル値及びランレングス値を表現するビット数である。
  - NBITは、GRIB2資料表現テンプレート5.200第5節12オクテットで示される「1データのビット数」である。
- 1セット内のレベル値とランレングス値の配置
  - ランレングス符号化されたデータ列の中で0以上MAXV以下の値は各格子点のレベル値で、MAXVよりも大きな値はランレングス値である。
  - 1セットは、最初にレベル値を配置し、もしその値が連続するのであれば後ろにランレングス値を付加して作成される。
  - MAXVよりも大きな値が続く場合、それらすべては当該セットのランレングス値である。
  - データに、MAXV以下の値が現れた時点で当該セットが終了し、このMAXV以下の値は次のセットのレベル値となる。
  - なお、同じレベル値が連続しない場合はランレングスは付加されず、次のセットに移る。
- ランレングス符号化方法
  - (2 ^ NBIT - MAXV)よりも大きなランレングスが必要となった場合、1データでは表現することができない。
  - これに対応するために、2つ以上のランレングス値を連続させてランレングスを表現するが、連続したデータの単純な総和をランレングスとしても圧縮効率があがらない。
  - よって、LNGU(=2 ^ NBIT - 1 - MAXV)進数を用いてランレングスを表現する。
  - レベル値のすぐ後に続く最初のランレングス値(data1)をLNGU進数の1桁目 RL1={LNGU ^ (1 - 1) * (data1 - (MAXV + 1))}とする。
  - それ以降n番目のランレングス値(dataN)は LNGU進数のn桁目 RLn={LNGU ^ (n - 1) * (dataN - (MAXV + 1))}とする。
  - 最終的なランレングスは、それらの「総和 + 1(RL = ΣRLi + 1)」となる。
- ランレングス符号化例
  - NBIT = 4、MAXV = 10とした場合、LNGU = 2 ^ 4 - 1 - 10 = 16 - 1 - 10 = 5となる。
  - ランレングス符号化列 = {3, 9, 12, 6, 4, 15, 2, 1, 0, 13, 12, 2, 3}は、以下の通り展開される。
  - {3, 9, 9, 6, 4, 4, 4, 4, 4, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 3}
  - レベル値とランレングス値のセット{9, 12}
    - 9がレベル値で12がランレングス値である。
    - 12の次は6であり、10以下であるため6はレベル値である。
    - `RL1 = 5 ^ (1 - 1) * (12 - (10 + 1)) = 1 * 1 = 1`
    - `RL = 1 + 1 = 2`
    - よって、9が２つ連続する。
  - レベル値とランレングス値のセット{0, 13, 12}
    - 0がレベル値で13と12がランレングス値である。
    - `RL1 = 5 ^ (1 - 1) * (13 - (10 + 1)) = 1* 2 = 2`
    - `RL2 = 5 ^ (2 - 1) * (12 - (10 + 1)) = 5 * 1 = 5`
    - `RL = 2 + 5 + 1 = 8`
    - よって、0が8連続する。
